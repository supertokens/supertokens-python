services:
  core:
    # Uses `$SUPERTOKENS_CORE_VERSION` when available, else latest
    image: supertokens/supertokens-dev-postgresql:${SUPERTOKENS_CORE_VERSION:-master}
    entrypoint: [
      "/usr/lib/supertokens/jre/bin/java",
      "-classpath", "/usr/lib/supertokens/core/*:/usr/lib/supertokens/plugin-interface/*:/usr/lib/supertokens/ee/*",
      "io.supertokens.Main", "/usr/lib/supertokens/", "DEV", "test_mode"
    ]
    ports:
      # Uses `$SUPERTOKENS_CORE_PORT` when available, else 3571 for local port
      - ${SUPERTOKENS_CORE_PORT:-3571}:3567
    platform: linux/amd64
    depends_on: [oauth]
    environment:
      OAUTH_PROVIDER_PUBLIC_SERVICE_URL: http://oauth:4444
      OAUTH_PROVIDER_ADMIN_SERVICE_URL: http://oauth:4445
      OAUTH_PROVIDER_CONSENT_LOGIN_BASE_URL: http://localhost:3001/auth
      OAUTH_CLIENT_SECRET_ENCRYPTION_KEY: asdfasdfasdfasdfasdf
      INFO_LOG_PATH: "null"
      ERROR_LOG_PATH: "null"
      LOG_LEVEL: "DEBUG"
    healthcheck:
      test: bash -c 'curl -s "http://127.0.0.1:3567/hello" | grep "Hello"'
      interval: 10s
      timeout: 5s
      retries: 5

  oauth:
    image: oryd/hydra:v2.2.0
    restart: unless-stopped
    environment:
      DSN: memory
      URLS_SELF_ISSUER: http://oauth:4444
      URLS_LOGIN: http://localhost:3001/auth/oauth/login
      URLS_CONSENT: http://localhost:3001/auth/oauth/consent
      URLS_LOGOUT: http://localhost:3001/auth/oauth/logout
      SECRETS_SYSTEM: thisIsATestSecretThatIsAtLeast32Chars
      SECRETS_COOKIE: thisIsATestCookieSecretAtLeast32
      SERVE_COOKIES_SAME_SITE_MODE: Lax
    healthcheck:
      test: ["CMD", "hydra", "health", "--endpoint", "http://127.0.0.1:4445"]
      interval: 5s
      timeout: 3s
      retries: 30
    mem_limit: 2g
    entrypoint: ["sh", "-c"]
    command: ["hydra migrate sql -e --yes && hydra serve all --dev"]

  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    ports:
      # Default MCP_PORT defined in mcp.env
      - "127.0.0.1:${MCP_PORT:-3001}:3000"
    environment:
      MCP_TRANSPORT: sse
      MCP_PORT: "3000"
      PYTHON_MCP_WORKSPACE: /workspace
      SUPERTOKENS_CORE_HOST: core
      SUPERTOKENS_CORE_PORT: "3567"
      SUPERTOKENS_ENV: testing
    volumes:
      - .:/workspace
      - pip-cache:/root/.cache/pip
      - pre-commit-cache:/root/.cache/pre-commit
      - ${BACKEND_SDK_TESTING_PATH:-../backend-sdk-testing}:/cross-sdk-tests
      - cross-sdk-node-modules:/cross-sdk-tests/node_modules
    depends_on:
      core:
        condition: service_healthy
    mem_limit: 8g
    cpus: 8
    pids_limit: 4096

volumes:
  pip-cache:
  pre-commit-cache:
  cross-sdk-node-modules:
